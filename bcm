#!/bin/bash

# note the absense of -u allows you to use environment variables from the parent shell
set -Eeo pipefail
cd "$(dirname "$0")"

# if this is 1, then we assume we are running BCM WITHOUT the front-end (e.g., dockerd on bare metal)
IS_FRONTEND=1
BCM_HELP_FLAG=0
REBUILD_IMAGES=0

for i in "$@"; do
    case $i in
        --help)
            BCM_HELP_FLAG=1
        ;;
        --backend-only)
            IS_FRONTEND=0
        ;;
        --rebuild)
            REBUILD_IMAGES=1
        ;;
        *)
            # unknown option
        ;;
    esac
done

if [[ $BCM_HELP_FLAG == 1 ]]; then
    cat ./commands/help.txt
    exit
fi

BCM_DEBUG=${BCM_DEBUG:-1}
export BCM_DEBUG="$BCM_DEBUG"
export REBUILD_IMAGES="$REBUILD_IMAGES"


BCM_SSH_HOSTNAME=${BCM_SSH_HOSTNAME:-"$(hostname)"}
if [[ ! -z $BCM_SSH_HOSTNAME ]]; then
    BCM_SSH_HOSTNAME="$BCM_SSH_HOSTNAME"
fi

BCM_SSH_USERNAME=${BCM_SSH_USERNAME:-"$(whoami)"}
if [[ ! -z $BCM_SSH_USERNAME ]]; then
    BCM_SSH_USERNAME="$BCM_SSH_USERNAME"
fi

GNUPGHOME=${GNUPGHOME:-"$HOME/.gnupg"}
if [[ ! -z $GNUPGHOME ]]; then
    GNUPGHOME="$GNUPGHOME"
fi
export GNUPGHOME="$GNUPGHOME"

BCM_DATACENTER=${BCM_DATACENTER:-"default"}
if [[ ! -z $BCM_DATACENTER ]]; then
    BCM_DATACENTER="$BCM_DATACENTER"
fi
export BCM_DATACENTER="$BCM_DATACENTER"

source ./bcm.env

# switch to 'master' for formal versions.
export BCM_DEFAULT_GIT_BRANCH="dev"
export BCM_ACTIVE_CHAIN="testnet"
export BCM_SSH_DIR="$HOME/.ssh" && mkdir -p "$BCM_SSH_DIR"
export BCM_STACKS_DIR="$BCM_GIT_DIR/stacks"
export BASE_DOCKER_IMAGE="ubuntu:$BCM_DOCKER_BASE_TAG"

PASSWORD_STORE_DIR="$HOME/.password_store" && mkdir -p "$PASSWORD_STORE_DIR"

export PASSWORD_STORE_DIR="$PASSWORD_STORE_DIR"
export LXC_BCM_BASE_IMAGE_NAME="bcm-template"

BCM_MANAGER_HOST_NAME="bcm-manager-01"
BCM_KAFKA_HOST_NAME="bcm-kafka-01"
BCM_UNDERLAY_HOST_NAME="bcm-underlay-01"
BCM_BITCOIN_HOST_NAME="bcm-bitcoin-$BCM_ACTIVE_CHAIN-01"

export BCM_MANAGER_HOST_NAME="$BCM_MANAGER_HOST_NAME"
export BCM_KAFKA_HOST_NAME="$BCM_KAFKA_HOST_NAME"
export BCM_UNDERLAY_HOST_NAME="$BCM_UNDERLAY_HOST_NAME"
export BCM_BITCOIN_HOST_NAME="$BCM_BITCOIN_HOST_NAME"
export BCM_GITHUB_REPO_URL="https://github.com/BitcoinCacheMachine/BitcoinCacheMachine"

export BCM_REGISTRY_MIRROR_PORT="5000"
export BCM_PRIVATE_REGISTRY_PORT="5010"
export BCM_PRIVATE_REGISTRY="$BCM_MANAGER_HOST_NAME:$BCM_PRIVATE_REGISTRY_PORT"
export BCM_KNOWN_HOSTS_FILE="$BCM_SSH_DIR/known_hosts"
export BCM_BACKUP_DIR="$HOME/.bcm_backups" && mkdir -p "$BCM_BACKUP_DIR"

export BCM_DOCKER_IMAGE_CACHE_FQDN="registry-1.docker.io"
export BCM_LXD_IMAGE_CACHE="images.linuxcontainers.org"


# let's make sure the local git client is using TOR for git pull operations.
# this should have been configured on a global level already when the user initially
# downloaded BCM from github
BCM_TOR_PROXY="socks5://127.0.0.1:9050"
if [[ "$(git config --get --local http.$BCM_GITHUB_REPO_URL.proxy)" != "$BCM_TOR_PROXY" ]]; then
    echo "Setting git client to use local SOCKS5 TOR proxy for push/pull operations."
    git config --local "http.$BCM_GITHUB_REPO_URL.proxy" "$BCM_TOR_PROXY"
fi

# this section configured the local SSH client on the Controller
# so it uses the local SOCKS5 proxy for any SSH host that has a
# ".onion" address. We use SSH tunneling to expose the remote onion
# server's LXD API and access it on the controller via a locally
# expose port (after SSH tunneling)
SSH_LOCAL_CONF="$HOME/.ssh/config"
if [[ ! -f "$SSH_LOCAL_CONF" ]]; then
    # if the .ssh/config file doesn't exist, create it.
    mkdir -p "$HOME/.ssh"
    touch "$SSH_LOCAL_CONF"
fi

# Next, paste in the necessary .ssh/config settings for accessing
# remote LXD servers over TOR hidden services. This will make any 'ssh' command
# redirect all .onion hostnames to your localhost:9050 tor SOCKS5 proxy.
if [[ -f "$SSH_LOCAL_CONF" ]]; then
    SSH_ONION_TEXT="Host *.onion"
    if ! grep -Fxq "$SSH_ONION_TEXT" "$SSH_LOCAL_CONF"; then
        echo "Info (IMPORTANT): Updating your /etc/ssh/sshd_config file so it redirects all *.onion names out your local Tor proxy."
        {
            echo "$SSH_ONION_TEXT"
            echo "    ProxyCommand nc -xlocalhost:9050 -X5 %h %p"
        } >>"$SSH_LOCAL_CONF"
    fi
fi

# if there's no group called lxd, create it.
if ! groups "$(whoami)" | grep -q lxd; then
    sudo gpasswd -a "$(whoami)" lxd
fi

# TODO - update trusted PGP certificate.
# echo "GNUPGHOME: $GNUPGHOME"
# if ! gpg --list-keys | grep -q 94C6163354CB7A8CE5BABCDB36DB4B9E5F3E523C; then
#     echo "WARNING: the BCM public key will be imported into your local system. "
#     echo "INFO: bcm commands WILL NOT RUN unless you have explicitly trusted this key."
#     echo "INFO: run 'sudo gpg --import $BCM_GIT_DIR/PGP.txt' to import the BCM key."
#     exit
# fi

# set our GNUPGHOME to the user cert directory
# if there is no certificate, go ahead and create it.
if [[ ! -d "$GNUPGHOME/trezor" ]]; then
    bash -c "$BCM_GIT_DIR/commands/init.sh"
fi

OLD_GNUPGHOME="$GNUPGHOME"
export GNUPGHOME="$GNUPGHOME/trezor"
DEFAULT_KEY_ID=$(gpg --no-permission-warning --list-keys --keyid-format LONG | grep nistp256 | grep pub | sed 's/^[^/]*:/:/')
DEFAULT_KEY_ID="${DEFAULT_KEY_ID#*/}"
DEFAULT_KEY_ID="$(echo "$DEFAULT_KEY_ID" | awk '{print $1}')"
export DEFAULT_KEY_ID="$DEFAULT_KEY_ID"
export GNUPGHOME="$OLD_GNUPGHOME"
# if LXC is not available, install it.
if [[ ! -f "$(command -v lxc)" ]]; then
    # install lxd via snap
    # unless this is modified, we get snapshot creation in snap when removing lxd.
    echo "INFO: Installing 'lxd' on $HOSTNAME."
    sudo snap install lxd --channel="candidate"
    sudo snap set system snapshots.automatic.retention=no
    sleep 5
fi

BASHRC_FILE="$HOME/.bashrc"
BASHRC_TEXT="export PATH=$""PATH:$HOME/git/github/bcm"
source "$BASHRC_FILE"
if ! grep -qF "$BASHRC_TEXT" "$BASHRC_FILE"; then
    echo "$BASHRC_TEXT" | tee -a "$BASHRC_FILE"
    exit
fi


# if the current cluster is not configured, let's bring it into existence.
if lxc info | grep -q "server_clustered: false"; then
    bash -c "./commands/cluster/entrypoint.sh cluster create"
fi

# Install docker if we're running this command on a front-end
if [[ $IS_FRONTEND = 1 ]]; then
    bash -c "$BCM_GIT_DIR/commands/controller/install_docker_client.sh"
    ./commands/cli_entrypoint.sh "$@"
fi
